<!DOCTYPE html>
<html>
<head>
    <title>AI Agent Manager</title>
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .agent-item {
            border: 1px solid #ddd;
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        .agent-item:hover {
            background-color: #f5f5f5;
            transform: translateX(2px);
        }
        .agent-item.selected {
            background-color: #e3f2fd;
            border-color: #2196f3;
            border-left: 4px solid #2196f3;
            box-shadow: 0 2px 4px rgba(33, 150, 243, 0.1);
        }
        .agent-details {
            display: none;
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .agent-details.active {
            display: block;
        }
        .control-panel {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        .output-panel {
            background-color: #f8f8f8;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .error {
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .message-container {
            margin: 10px 0;
        }
        .error-message {
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        .success-message {
            color: #155724;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        .agent-state {
            padding: 5px 10px;
            margin-bottom: 15px;
            display: inline-block;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .state-running {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .state-stopped {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .state-completed {
            background-color: #cce5ff;
            color: #004085;
            border: 1px solid #b8daff;
        }
        
        .state-unknown {
            background-color: #ffeeba;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        .output-panel {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .output-panel div {
            font-family: monospace;
            white-space: pre-wrap;
            margin: 2px 0;
        }
        .agent-form {
            background: white;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        #tools {
            height: 100px;
        }
        .run-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .run-time {
            font-size: 0.8em;
            color: #666;
        }

        .run-task {
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .run-info {
            margin-bottom: 20px;
        }

        .run-task-details, .run-result {
            margin-top: 20px;
        }

        .run-task-details pre, .run-result pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }

        .panel-content {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
        }

        .runs-panel {
            margin-top: 20px;
        }

        .runs-header {
            background-color: #f8f9fa;
            padding: 10px 15px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .runs-header:hover {
            background-color: #e9ecef;
        }

        .runs-header h3 {
            margin: 0;
        }

        .runs-header .toggle-icon {
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }

        .runs-header .toggle-icon.expanded {
            transform: rotate(180deg);
        }

        .runs-content {
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 4px 4px;
            padding: 15px;
            display: none;
        }

        .runs-content.expanded {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AI Agent Manager</h1>
        
        <div class="layout">
            <!-- Left panel: Agents list and creation -->
            <div class="agents-panel">
                <h2>Agents</h2>
                <div id="agentsList"></div>
                <button onclick="createNewAgent()">Create New Agent</button>
                
                <div class="message-container">
                    <div id="errorMessage" class="error-message"></div>
                    <div id="successMessage" class="success-message"></div>
                </div>

                <div id="agentForm" class="agent-form" style="display: none;">
                    <h3 id="formTitle">Create New Agent</h3>
                    <form onsubmit="handleAgentSubmit(event)">
                        <div class="form-group">
                            <label for="agentName">Agent Name:</label>
                            <input type="text" id="agentName" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="modelName">Model:</label>
                            <select id="modelName" required>
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                <option value="gpt-4-turbo-preview">GPT-4 Turbo</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="agentType">Agent Type:</label>
                            <select id="agentType" required>
                                <option value="storyteller">Storyteller</option>
                                <option value="default">Default</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="temperature">Temperature (0-1):</label>
                            <input type="number" id="temperature" min="0" max="1" step="0.1" value="0.7" required>
                        </div>

                        <div class="form-group">
                            <label for="tools">Tools:</label>
                            <select id="tools" multiple>
                                <option value="code_interpreter">Code Interpreter</option>
                                <option value="web_search">Web Search</option>
                            </select>
                        </div>

                        <input type="hidden" id="agentId">
                        <div class="form-buttons">
                            <button type="submit" id="submitButton">Create Agent</button>
                            <button type="button" onclick="cancelForm()">Cancel</button>
                        </div>
                    </form>
                </div>

                <!-- Right panel: Agent details and controls -->
                <div id="agentDetails" class="agent-details">                    
                    <h2 id="selectedAgentName"></h2>
                    <div id="agentState" class="agent-state"></div>
                    
                    <div class="control-panel">
                        <button onclick="runAgent()">Run Agent</button>
                        <button onclick="stopAgent()">Stop Agent</button>
                        <button onclick="editAgent()">Edit Agent</button>
                        <button onclick="deleteAgent()">Delete Agent</button>
                    </div>

                    <div class="editor-panel">
                        <h3>Agent Configuration</h3>
                        <textarea id="agentConfig" rows="10" style="width: 100%"></textarea>
                    </div>

                    <div class="runs-panel">
                        <div class="runs-header" onclick="toggleRuns()">
                            <h3>Agent Runs</h3>
                            <span class="toggle-icon">▼</span>
                        </div>
                        <div class="runs-content" id="runsContent">
                            <div id="runsList"></div>
                        </div>
                    </div>

                    <div class="output-panel">
                        <h3>Output</h3>
                        <div id="agentOutput"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedAgent = null;
        let selectedRun = null;

        async function loadAgents() {
            try {
                console.log("Loading agents...");
                const response = await fetch('/api/agents');
                console.log("Response status:", response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const agents = await response.json();
                console.log("Received agents:", agents);
                
                const agentsList = document.getElementById('agentsList');
                
                // Ensure agents is an array
                const agentsArray = Array.isArray(agents) ? agents : [];
                console.log("Processed agents array:", agentsArray);
                
                if (agentsArray.length === 0) {
                    agentsList.innerHTML = '<div class="info">No agents found. Create one to get started!</div>';
                    return;
                }
                
                agentsList.innerHTML = agentsArray.map(agent => `
                    <div class="agent-item ${agent.id === selectedAgent ? 'selected' : ''}" 
                         data-agent-id="${agent.id}"
                         onclick="selectAgent('${agent.id}')">
                        <h3>${agent.name}</h3>
                        <p>Type: ${agent.type || 'default'}</p>
                        <p>Status: ${agent.status}</p>
                        <p>Model: ${agent.config?.model_name || 'gpt-3.5-turbo'}</p>
                        <p>Temperature: ${agent.config?.temperature || '0.7'}</p>
                        <p>Created: ${new Date(agent.created_at).toLocaleString()}</p>
                    </div>
                `).join('');
                console.log("Updated agents list HTML");
                
            } catch (error) {
                console.error('Error loading agents:', error);
                document.getElementById('agentsList').innerHTML = 
                    '<div class="error">Failed to load agents. Please try again later.</div>';
            }
        }

        async function createAgent(event) {
            event.preventDefault();
            try {
                const nameInput = document.getElementById('agentName');
                const response = await fetch('/api/agents', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name: nameInput.value})
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                nameInput.value = '';
                await loadAgents();
                showSuccess('Agent created successfully');
            } catch (error) {
                console.error('Error creating agent:', error);
                showError('Failed to create agent. Please try again.');
            }
        }

        function hideAllPanels() {
            document.getElementById('agentForm').style.display = 'none';
            document.getElementById('agentDetails').classList.remove('active');
        }

        async function loadAgentTypes() {
            try {
                const response = await fetch('/api/agent-types');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const agentTypes = await response.json();
                const agentTypeSelect = document.getElementById('agentType');
                
                // Clear existing options
                agentTypeSelect.innerHTML = '';
                
                // Add agent types with descriptions
                agentTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.type;
                    option.text = type.name;
                    option.title = type.description; // Adds a tooltip with the description
                    agentTypeSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading agent types:', error);
                showError('Failed to load agent types');
            }
        }

        async function createNewAgent() {
            hideAllPanels();
            // Reset form
            document.getElementById('formTitle').textContent = 'Create New Agent';
            document.getElementById('submitButton').textContent = 'Create Agent';
            document.getElementById('agentId').value = '';
            document.getElementById('agentName').value = '';
            document.getElementById('modelName').value = 'gpt-3.5-turbo';
            document.getElementById('temperature').value = '0.7';
            // Reset tools selection
            const toolsSelect = document.getElementById('tools');
            Array.from(toolsSelect.options).forEach(option => option.selected = false);
            // Load agent types
            await loadAgentTypes();
            // Show form
            document.getElementById('agentForm').style.display = 'block';
        }

        async function selectAgent(agentId) {
            try {
                hideAllPanels();
                selectedAgent = agentId;
                
                // Update visual selection
                document.querySelectorAll('.agent-item').forEach(item => {
                    item.classList.remove('selected');
                });
                document.querySelector(`.agent-item[data-agent-id="${agentId}"]`)?.classList.add('selected');
                
                const response = await fetch(`/api/agents/${agentId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const agent = await response.json();
                
                document.getElementById('agentDetails').classList.add('active');
                document.getElementById('selectedAgentName').textContent = agent.name;
                document.getElementById('agentConfig').value = JSON.stringify(agent.config, null, 2);
                
                // Add state display
                const stateElement = document.getElementById('agentState');
                stateElement.textContent = agent.status;
                stateElement.className = 'agent-state';
                stateElement.classList.add(`state-${agent.status.toLowerCase()}`);

                // Load runs
                await loadAgentRuns();
                // Automatically expand runs panel when agent is selected
                document.getElementById('runsContent').classList.add('expanded');
                document.querySelector('.runs-header .toggle-icon').classList.add('expanded');
            } catch (error) {
                console.error('Error selecting agent:', error);
                showError('Failed to load agent details');
            }
        }

        async function runAgent() {
            if (!selectedAgent) return;
            try {
                // Get current agent configuration
                const agentResponse = await fetch(`/api/agents/${selectedAgent}`);
                if (!agentResponse.ok) {
                    throw new Error(`HTTP error! status: ${agentResponse.status}`);
                }
                const agent = await agentResponse.json();

                // Prepare task input based on agent type
                let taskData;
                if (agent.type === 'storyteller') {
                    const theme = prompt('Enter a theme for the story:', '');
                    if (!theme) return;  // User cancelled
                    taskData = {
                        task: "generate_story",
                        params: {
                            theme: theme
                        }
                    };
                } else {
                    const taskInput = prompt('Enter task for the agent:', '');
                    if (!taskInput) return;  // User cancelled
                    taskData = {
                        task: "default",
                        params: {
                            input: taskInput
                        }
                    };
                }

                const response = await fetch(`/api/agents/${selectedAgent}/tasks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(taskData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Start polling for updates
                pollAgentOutput();
                showSuccess('Agent started successfully');
            } catch (error) {
                console.error('Error running agent:', error);
                showError('Failed to run agent. Please try again.');
            }
        }

        async function stopAgent() {
            if (!selectedAgent) return;
            try {
                await fetch(`/api/agents/${selectedAgent}/stop`, {method: 'POST'});
                showSuccess('Agent stopped successfully');
            } catch (error) {
                showError('Failed to stop agent');
            }
        }

        async function editAgent() {
            if (!selectedAgent) return;
            
            try {
                hideAllPanels();
                // First fetch the current agent data
                const response = await fetch(`/api/agents/${selectedAgent}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const agent = await response.json();
                
                // Now populate the form with the agent data
                const form = document.getElementById('agentForm');
                document.getElementById('formTitle').textContent = 'Edit Agent';
                document.getElementById('submitButton').textContent = 'Update Agent';
                document.getElementById('agentId').value = selectedAgent;
                document.getElementById('agentName').value = agent.name;
                
                // Set agent type
                const agentTypeSelect = document.getElementById('agentType');
                agentTypeSelect.value = agent.type || 'default';
                
                // Set model name with fallback
                const modelSelect = document.getElementById('modelName');
                modelSelect.value = agent.config?.model_name || 'gpt-3.5-turbo';
                
                // Set temperature with fallback
                const temperatureInput = document.getElementById('temperature');
                temperatureInput.value = agent.config?.temperature || 0.7;
                
                // Set selected tools with proper type checking
                const toolsSelect = document.getElementById('tools');
                const tools = agent.config?.tools || [];
                Array.from(toolsSelect.options).forEach(option => {
                    option.selected = tools.some(tool => 
                        typeof tool === 'string' ? tool === option.value : 
                        typeof tool === 'object' && tool !== null ? tool.type === option.value : 
                        false
                    );
                });
                
                form.style.display = 'block';
            } catch (error) {
                console.error('Error loading agent:', error);
                showError('Failed to load agent configuration');
            }
        }

        async function deleteAgent() {
            if (!selectedAgent) return;
            try {
                const response = await fetch(`/api/agents/${selectedAgent}`, {method: 'DELETE'});
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                document.getElementById('agentDetails').classList.remove('active');
                await loadAgents();
                showSuccess('Agent deleted successfully');
            } catch (error) {
                showError('Failed to delete agent');
            }
        }

        async function loadAgentRuns() {
            if (!selectedAgent) return;
            
            try {
                const response = await fetch(`/api/agents/${selectedAgent}/runs`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const runs = await response.json();
                
                const runsList = document.getElementById('runsList');
                if (runs.length === 0) {
                    runsList.innerHTML = '<div class="info">No runs yet</div>';
                    return;
                }
                
                runsList.innerHTML = runs.map(run => `
                    <div class="run-item ${run.run_id === selectedRun ? 'selected' : ''}" 
                         onclick="toggleRunDetails('${run.run_id}', this)">
                        <div class="run-header">
                            <span class="run-status state-${run.status.toLowerCase()}">${run.status}</span>
                            <span class="run-time">${new Date(run.started_at).toLocaleString()}</span>
                        </div>
                        <div class="run-task">
                            ${formatTask(run.task)}
                        </div>
                        <div class="run-details" id="details-${run.run_id}">
                            <div class="run-info">
                                <p><strong>Started:</strong> ${new Date(run.started_at).toLocaleString()}</p>
                                ${run.completed_at ? 
                                    `<p><strong>Completed:</strong> ${new Date(run.completed_at).toLocaleString()}</p>` : 
                                    ''}
                            </div>
                            <div class="run-task-details">
                                <h4>Task Details</h4>
                                <pre>${JSON.stringify(run.task, null, 2)}</pre>
                            </div>
                            <div class="run-result">
                                <h4>Result</h4>
                                <pre>${formatResult(run.result)}</pre>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading runs:', error);
                document.getElementById('runsList').innerHTML = 
                    '<div class="error">Failed to load runs</div>';
            }
        }

        function formatTask(task) {
            if (task.task === "generate_story") {
                return `Story: ${task.params?.theme || 'No theme'}`;
            }
            if (task.task === "default") {
                return `Task: ${task.params?.input || 'No input'}`;
            }
            if (task.raw) {
                return `Raw task: ${task.raw}`;
            }
            return JSON.stringify(task);
        }

        function formatResult(result) {
            try {
                if (typeof result === 'string') {
                    return result;
                }
                if (result.result) {
                    return result.result;
                }
                if (result.raw) {
                    return result.raw;
                }
                return JSON.stringify(result, null, 2);
            } catch (e) {
                return 'Error displaying result';
            }
        }

        function toggleRunDetails(runId, element) {
            selectedRun = runId;
            
            // Update selected state
            document.querySelectorAll('.run-item').forEach(item => {
                item.classList.remove('selected');
            });
            element.classList.add('selected');
            
            // Toggle details
            const details = document.getElementById(`details-${runId}`);
            document.querySelectorAll('.run-details').forEach(detail => {
                if (detail !== details) {
                    detail.classList.remove('active');
                }
            });
            details.classList.toggle('active');
        }

        // Update pollAgentOutput to use loadAgentRuns
        async function pollAgentOutput() {
            if (!selectedAgent) return;
            
            // Clear existing interval if any
            if (window.outputInterval) {
                clearInterval(window.outputInterval);
            }
            
            // Initial load
            await loadAgentRuns();
            await updateAgentStatus();  // Add initial status update
            
            window.outputInterval = setInterval(async () => {
                try {
                    await loadAgentRuns();
                    await updateAgentStatus();  // Add status update to polling
                } catch (error) {
                    console.error('Error polling runs:', error);
                    clearInterval(window.outputInterval);
                }
            }, 3000);
        }

        // Add new function to update agent status
        async function updateAgentStatus() {
            if (!selectedAgent) return;
            
            try {
                const response = await fetch(`/api/agents/${selectedAgent}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const agent = await response.json();
                
                // Update the status display
                const stateElement = document.getElementById('agentState');
                stateElement.textContent = agent.status;
                stateElement.className = 'agent-state';
                stateElement.classList.add(`state-${agent.status.toLowerCase()}`);
                
                // If agent is no longer running, stop polling
                if (agent.status !== 'RUNNING') {
                    clearInterval(window.outputInterval);
                }
            } catch (error) {
                console.error('Error updating agent status:', error);
            }
        }

        // Load agents and agent types when page loads
        loadAgents();
        loadAgentTypes();

        // Add event listener for Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const agentDetails = document.getElementById('agentDetails');
                const agentForm = document.getElementById('agentForm');
                hideAllPanels();
                selectedAgent = null;
                document.querySelectorAll('.agent-item').forEach(item => {
                    item.classList.remove('selected');
                });
            }
        });

        // Add utility functions for showing messages
        function showError(message, duration = 5000) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, duration);
        }

        function showSuccess(message, duration = 3000) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, duration);
        }

        function cancelForm() {
            hideAllPanels();
            // If we were editing, go back to showing the agent details
            if (selectedAgent) {
                selectAgent(selectedAgent);
            }
        }

        async function handleAgentSubmit(event) {
            event.preventDefault();
            const agentId = document.getElementById('agentId').value;
            const isEdit = !!agentId;

            const agentData = {
                name: document.getElementById('agentName').value,
                type: document.getElementById('agentType').value,
                config: {
                    model_name: document.getElementById('modelName').value,
                    temperature: parseFloat(document.getElementById('temperature').value),
                    tools: Array.from(document.getElementById('tools').selectedOptions).map(opt => ({
                        type: opt.value
                    }))
                }
            };

            try {
                let response;
                if (isEdit) {
                    response = await fetch(`/api/agents/${agentId}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(agentData)
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.detail || 'Failed to update agent');
                    }
                    
                    // Wait for the response to ensure update was successful
                    const result = await response.json();
                    if (result.status !== 'updated') {
                        throw new Error('Failed to update agent: Unexpected response');
                    }
                    
                    showSuccess('Agent updated successfully');
                } else {
                    response = await fetch('/api/agents', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(agentData)
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.detail || 'Failed to create agent');
                    }
                    
                    showSuccess('Agent created successfully');
                }
                
                hideAllPanels();
                await loadAgents();
                
                if (isEdit) {
                    await selectAgent(agentId);
                }
            } catch (error) {
                console.error('Error:', error);
                showError(error.message || `Failed to ${isEdit ? 'update' : 'create'} agent`);
            }
        }

        function toggleRuns() {
            const content = document.getElementById('runsContent');
            const icon = document.querySelector('.runs-header .toggle-icon');
            
            content.classList.toggle('expanded');
            icon.classList.toggle('expanded');
        }
    </script>
</body>
</html> 